<!DOCTYPE html>
<html>
<head>
  <title>Monitor de Tensão em Tempo Real</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .chart-container {
      margin: 30px 0;
      position: relative;
      height: 300px;
    }
    .status {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    #pauseButton {
      padding: 8px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    #pauseButton:hover {
      background: #45a049;
    }
    #pauseButton.paused {
      background: #f44336;
    }
    #pauseButton.paused:hover {
      background: #d32f2f;
    }
  </style>
</head>
<body>
  <h1>Monitor de Tensão em Tempo Real</h1>
  <button id="pauseButton">Pausar</button>
  <div class="status" id="status">Conectando...</div>

  <div class="chart-container">
    <canvas id="tensaoChart"></canvas>
  </div>

  <div class="chart-container">
    <canvas id="correnteChart"></canvas>
  </div>

  <div class="chart-container">
    <canvas id="potenciaChart"></canvas>
  </div>

  <script>
    // Configuração inicial
    const MAX_DATA_POINTS = 20;
    const TIMEOUT_MS = 5000; // 5 segundos sem dados = pausa
    let history = {
      labels: [],
      tensao: [],
      corrente: [],
      potencia: [],
      tensao_shunt: []
    };
    let lastUpdateTime = Date.now();
    let isPaused = false;
    let updateInterval;
    let timeoutCheckInterval;

    // Elementos do DOM
    const statusElement = document.getElementById('status');
    const pauseButton = document.getElementById('pauseButton');

    // Inicializa gráficos
    const tensaoChart = createChart('tensaoChart', 'Tensão (V)', 'rgba(54, 162, 235, 1)');
    const correnteChart = createChart('correnteChart', 'Corrente (mA)', 'rgba(255, 99, 132, 1)');
    const potenciaChart = createChart('potenciaChart', 'Potência (mW)', 'rgba(75, 192, 192, 1)');

    // Função para criar gráficos
    function createChart(id, label, color) {
      const ctx = document.getElementById(id).getContext('2d');
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: label,
            data: [],
            borderColor: color,
            borderWidth: 2,
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: false }
          },
          animation: {
            duration: 0 // Desativa animações para atualização em tempo real
          }
        }
      });
    }

    // Atualiza todos os gráficos
    function updateCharts(newData) {
      const timestamp = new Date().toLocaleTimeString();
      
      // Adiciona novos dados ao histórico
      history.labels.push(timestamp);
      history.tensao.push(newData.tensao);
      history.corrente.push(newData.corrente);
      history.potencia.push(newData.potencia);
      
      // Limita o histórico ao número máximo de pontos
      if (history.labels.length > MAX_DATA_POINTS) {
        history.labels.shift();
        history.tensao.shift();
        history.corrente.shift();
        history.potencia.shift();
      }
      
      // Atualiza gráficos
      updateChart(tensaoChart, history.labels, history.tensao);
      updateChart(correnteChart, history.labels, history.corrente);
      updateChart(potenciaChart, history.labels, history.potencia);
    }

    function updateChart(chart, labels, data) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
    }

    // Função para pausar/retomar
    function togglePause() {
      isPaused = !isPaused;
      
      if (isPaused) {
        pauseButton.textContent = 'Retomar';
        pauseButton.classList.add('paused');
        clearInterval(updateInterval);
        statusElement.textContent = 'Gráficos pausados manualmente';
        statusElement.style.color = 'orange';
      } else {
        pauseButton.textContent = 'Pausar';
        pauseButton.classList.remove('paused');
        startAutoUpdate();
        fetchData(); // Força atualização imediata
      }
    }

    // Inicia atualização automática
    function startAutoUpdate() {
      if (updateInterval) clearInterval(updateInterval);
      updateInterval = setInterval(fetchData, 3000);
    }

    // Verifica timeout
    function checkTimeout() {
      if (isPaused) return;
      
      const timeSinceLastUpdate = Date.now() - lastUpdateTime;
      if (timeSinceLastUpdate > TIMEOUT_MS) {
        statusElement.textContent = `Pausado - Sem dados há ${Math.floor(timeSinceLastUpdate/1000)}s`;
        statusElement.style.color = 'orange';
        clearInterval(updateInterval);
      }
    }

    // Busca dados da API
    async function fetchData() {
      if (isPaused) return;
      
      try {
        const response = await fetch('https://projeto-tensao-rasp.vercel.app/api/tensao');
        const data = await response.json();
        
        if (data.tensao !== undefined) {
          lastUpdateTime = Date.now();
          statusElement.textContent = `Última leitura: ${new Date().toLocaleTimeString()}`;
          statusElement.style.color = 'green';
          updateCharts(data);
        } else {
          statusElement.textContent = 'Aguardando dados...';
          statusElement.style.color = 'orange';
        }
      } catch (error) {
        console.error('Erro:', error);
        statusElement.textContent = 'Erro ao conectar na API';
        statusElement.style.color = 'red';
      }
    }

    // Event listeners
    pauseButton.addEventListener('click', togglePause);
    
    // Inicia os intervalos
    startAutoUpdate();
    timeoutCheckInterval = setInterval(checkTimeout, 1000);
    fetchData(); // Primeira chamada

    // Limpeza ao sair da página
    window.addEventListener('beforeunload', () => {
      clearInterval(updateInterval);
      clearInterval(timeoutCheckInterval);
    });
  </script>
</body>
</html>