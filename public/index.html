<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Monitor de Tensão</title>
  <!-- Ícone do site -->
  <link rel="icon" type="image/png" href="/assets/favicon.png">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

  <div class="container py-4">
    <h2 class="mb-3">Monitor de Tensão</h2>

    <div class="card shadow-sm">
      <div class="card-body">
        <canvas id="tensaoChart" style="height:400px;"></canvas>
      </div>
    </div>

    <!-- Linha para exibir data da última atualização -->
    <div class="mt-2">
      <p id="dataStatus" class="text-muted"></p>
    </div>

    <div class="mt-3">
      <a href="#" class="btn btn-primary btn-sm" onclick="location.reload()">🔄 Atualizar agora</a>
      <a href="/tabela.html" class="btn btn-secondary btn-sm">📋 Ver tabela</a>
      <a href="/resumo.html" class="btn btn-info btn-sm">📈 Ver resumo</a>
    </div>
  </div>

<script>
  const ctx = document.getElementById('tensaoChart').getContext('2d');
  const tensaoChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Tensão (V)',
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13,110,253,0.2)',
        fill: true,
        data: [],
        tension: 0.3,
        pointRadius: 2,
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: false }
      }
    }
  });

  async function updateChart() {
    try {
      const res = await fetch('https://projeto-tensao-rasp.vercel.app/api/tensao');
      const data = await res.json();

      // Reverte e pega até 50 pontos recentes
      const reversedData = data.reverse().slice(-50); 
      
      // Atualiza o gráfico
      tensaoChart.data.labels = reversedData.map(d => 
        new Date(d.timestamp).toLocaleTimeString('pt-BR')
      );
      tensaoChart.data.datasets[0].data = reversedData.map(d => 
        parseFloat(d.tensao.toFixed(2))
      );
      tensaoChart.update();

      // Exibir apenas a data do último registro (mais recente)
      if (reversedData.length > 0) {
        const ultimo = reversedData[reversedData.length - 1]; // último item do array reversedData
        const dataFormatada = new Date(ultimo.timestamp)
          .toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });

        document.getElementById('dataStatus').textContent = 
          `Última atualização: ${dataFormatada}`;
      } else {
        document.getElementById('dataStatus').textContent = 'Nenhuma leitura disponível';
      }

    } catch (err) {
      console.error('Erro ao atualizar gráfico:', err);
      document.getElementById('dataStatus').textContent = 'Erro ao carregar dados';
    }
  }

  // Atualiza ao carregar a página e depois a cada 5 segundos
  updateChart();
  setInterval(updateChart, 5000);
</script>

</body>
</html>
