<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Resumo Di√°rio - Tens√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4">Resumo Di√°rio de Tens√£o</h2>

  <div class="row mb-3">
    <div class="col-md-3">
      <label class="form-label">Escolha a data</label>
      <input type="date" id="dataSelecionada" class="form-control">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" id="consultarResumo">üîç Consultar</button>
    </div>
    <div class="col-md-7 d-flex align-items-end">
      <div class="d-flex gap-2 w-100">
        <button class="btn btn-outline-secondary w-100" onclick="resetarZoom()">üîÑ Resetar Zoom</button>
        <button class="btn btn-outline-success w-100" onclick="baixarGrafico()">üì∑ Baixar gr√°fico</button>
        <button class="btn btn-outline-info w-100" onclick="baixarCSV()">üìÑ Exportar CSV</button>
        <a href="/" class="btn btn-secondary w-100">üè† Voltar</a>
      </div>
    </div>
  </div>

  <div class="row text-center mb-4" id="resumoCards"></div>

  <div class="card">
    <div class="card-body">
      <canvas id="graficoResumo" style="height:400px;"></canvas>
    </div>
  </div>
</div>

<script>
  let grafico;

  document.addEventListener("DOMContentLoaded", () => {
    const ctx = document.getElementById("graficoResumo").getContext("2d");

    grafico = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Tens√£o (V)",
          data: [],
          borderColor: "#0d6efd",
          backgroundColor: "rgba(13,110,253,0.1)",
          fill: true,
          tension: 0.1,
          pointRadius: 0.5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 15
            }
          }
        },
        plugins: {
          decimation: {
            enabled: true,
            algorithm: 'lttb',
            samples: 1000
          },
          zoom: {
            pan: {
              enabled: true,
              mode: 'x',
              modifierKey: null,  // permite pan com bot√£o esquerdo
              overScaleMode: 'x',
              threshold: 10, // suavidade do in√≠cio do pan
            },
            zoom: {
              wheel: { enabled: true },
              pinch: { enabled: true },
              mode: 'x'
            }
          }
        }
      }
    });

    document.getElementById("consultarResumo").addEventListener("click", carregarResumo);

    const hoje = new Date().toISOString().split("T")[0];
    document.getElementById("dataSelecionada").value = hoje;
    carregarResumo();
  });

  function resetarZoom() {
    grafico.resetZoom();
  }

  function baixarGrafico() {
    const link = document.createElement("a");
    link.download = "grafico_tensao.png";
    link.href = grafico.toBase64Image();
    link.click();
  }

  function baixarCSV() {
    const labels = grafico.data.labels;
    const dados = grafico.data.datasets[0].data;

    let csv = "timestamp,tensao\n";
    for (let i = 0; i < labels.length; i++) {
      csv += `${labels[i]},${dados[i]}\n`;
    }

    const blob = new Blob([csv], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "leituras_tensao.csv";
    a.click();
    window.URL.revokeObjectURL(url);
  }

  function carregarResumo() {
    const data = document.getElementById("dataSelecionada").value;
    const url = data
      ? `https://projeto-tensao-rasp.vercel.app/api/resumo?data=${data}`
      : `https://projeto-tensao-rasp.vercel.app/api/resumo`;

    fetch(url)
      .then(res => res.json())
      .then(res => {
        const { dados, resumo, dataSelecionada } = res;

        grafico.data.labels = dados.map(d => {
          const t = new Date(d.timestamp);
          return t.toLocaleTimeString("pt-BR", { timeZone: "America/Sao_Paulo" });
        });

        grafico.data.datasets[0].data = dados.map(d => parseFloat(d.tensao.toFixed(2)));

        // Encontrar √≠ndices dos pontos m√≠nimo e m√°ximo
        const dadosValores = grafico.data.datasets[0].data;
        const idxMax = dadosValores.indexOf(Math.max(...dadosValores));
        const idxMin = dadosValores.indexOf(Math.min(...dadosValores));

        // Adiciona estilos visuais aos pontos
        grafico.data.datasets[0].pointRadius = dadosValores.map((_, i) => {
        if (i === idxMax || i === idxMin) return 5;
        return 0;
        });

        grafico.data.datasets[0].pointBackgroundColor = dadosValores.map((_, i) => {
        if (i === idxMax) return '#dc3545';     // vermelho (m√°ximo)
        if (i === idxMin) return '#0d6efd';     // azul (m√≠nimo)
        return 'transparent';
        });

        grafico.update();

        const horaMin = new Date(resumo.horario_minimo).toLocaleTimeString("pt-BR", { timeZone: "America/Sao_Paulo" });
        const horaMax = new Date(resumo.horario_maximo).toLocaleTimeString("pt-BR", { timeZone: "America/Sao_Paulo" });

        document.getElementById("resumoCards").innerHTML = `
          <div class="col-md-4">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">üìä M√©dia</h5>
                <p class="card-text fs-4">${parseFloat(resumo.media).toFixed(2)} V</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">üîΩ M√≠nimo</h5>
                <p class="card-text fs-4">${parseFloat(resumo.minimo).toFixed(2)} V √†s ${horaMin}</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">üîº M√°ximo</h5>
                <p class="card-text fs-4">${parseFloat(resumo.maximo).toFixed(2)} V √†s ${horaMax}</p>
              </div>
            </div>
          </div>
        `;

        document.getElementById("dataSelecionada").value = dataSelecionada;
      })
      .catch(err => {
        console.error("Erro ao carregar resumo:", err);
      });
  }
</script>

</body>
</html>
